<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Money Pro - Monthly Analytics</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%235F7444%22 rx=%2220%22/><text y=%22.75em%22 x=%225%22 font-size=%2270%22>üí∞</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --bg: #FDFBF0; --primary: #5F7444; --accent: #E9967A; --text: #4A4A4A; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg); color: var(--text); -webkit-tap-highlight-color: transparent; transition: all 0.3s ease; }
        .card { background: white; border-radius: 24px; border: 1px solid rgba(0,0,0,0.05); }
        .tab-active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .shortcut-btn { padding: 8px 14px; border-radius: 12px; font-size: 11px; font-weight: 600; background: white; border: 1px solid rgba(0,0,0,0.1); white-space: nowrap; }
        .progress-bar { height: 12px; border-radius: 20px; background: rgba(0,0,0,0.05); overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.6s ease, background-color 0.4s; }
        .theme-dot { width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .month-btn { padding: 6px 12px; border-radius: 10px; font-size: 10px; font-weight: bold; background: rgba(0,0,0,0.05); color: #999; flex-shrink: 0; }
        .month-btn.active { background: var(--primary); color: white; }
    </style>
</head>
<body class="pb-24">

    <div id="setModal" class="fixed inset-0 bg-black/60 z-[120] hidden flex items-center justify-center p-6 backdrop-blur-md">
        <div class="card w-full max-w-sm p-8 space-y-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center">
                <h3 class="font-bold text-lg" data-k="settings">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3>
                <button onclick="toggleModal('setModal', false)" class="text-xl">‚úï</button>
            </div>
            <div class="space-y-2">
                <label class="text-[10px] font-bold opacity-40 uppercase" data-k="langTitle">‡∏†‡∏≤‡∏©‡∏≤ / Language</label>
                <div class="flex gap-2">
                    <button onclick="setLang('th')" id="lTH" class="flex-1 py-2 rounded-xl border font-bold text-xs">‡πÑ‡∏ó‡∏¢</button>
                    <button onclick="setLang('en')" id="lEN" class="flex-1 py-2 rounded-xl border font-bold text-xs">EN</button>
                </div>
            </div>
            <div class="space-y-2">
                <label class="text-[10px] font-bold opacity-40 uppercase" data-k="themeTitle">‡∏ò‡∏µ‡∏°‡∏™‡∏µ / Theme</label>
                <div class="grid grid-cols-6 gap-2">
                    <div onclick="setTheme('lemon')" class="theme-dot" style="background: #A1C298;"></div>
                    <div onclick="setTheme('sakura')" class="theme-dot" style="background: #F8BBD0;"></div>
                    <div onclick="setTheme('sea')" class="theme-dot" style="background: #B9EDDD;"></div>
                    <div onclick="setTheme('ocean')" class="theme-dot" style="background: #297376;"></div>
                    <div onclick="setTheme('classic')" class="theme-dot" style="background: #5F7444;"></div>
                    <div onclick="setTheme('midnight')" class="theme-dot" style="background: #013137;"></div>
                </div>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold opacity-40 uppercase" data-k="setBud">‡∏á‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                    <input type="number" id="confB" class="w-full p-3 bg-black/5 rounded-xl outline-none font-bold">
                </div>
                <div>
                    <label class="text-[10px] font-bold opacity-40 uppercase" data-k="setGoal">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö</label>
                    <input type="number" id="confG" class="w-full p-3 bg-black/5 rounded-xl outline-none font-bold">
                </div>
            </div>
            <button onclick="saveConf()" class="w-full py-4 bg-stone-800 text-white rounded-2xl font-bold" data-k="save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </div>

    <div id="reportModal" class="fixed inset-0 bg-black/60 z-[110] hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="card w-full max-w-md p-6 space-y-5 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center sticky top-0 bg-white pb-2 z-10">
                <h3 class="font-bold text-lg" data-k="analytics">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <button onclick="toggleModal('reportModal', false)" class="text-xl">‚úï</button>
            </div>

            <div id="monthSelector" class="flex gap-2 overflow-x-auto no-scrollbar py-2 border-b"></div>

            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-3">
                    <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                        <p class="text-[9px] font-bold text-emerald-700 opacity-60 uppercase" data-k="monthIn">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</p>
                        <p id="monthInTotal" class="text-lg font-bold text-emerald-600">‡∏ø0</p>
                    </div>
                    <div class="p-4 bg-rose-50 rounded-2xl border border-rose-100">
                        <p class="text-[9px] font-bold text-rose-700 opacity-60 uppercase" data-k="monthEx">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</p>
                        <p id="monthExTotal" class="text-lg font-bold text-rose-600">‡∏ø0</p>
                    </div>
                </div>
                <div class="h-64"><canvas id="reportBarChart"></canvas></div>
                <div class="grid grid-cols-1 gap-4">
                    <div class="space-y-2">
                        <p class="text-[10px] font-bold text-rose-500 uppercase px-1">üîù TOP EXPENSES</p>
                        <div id="topExList" class="space-y-1"></div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-[10px] font-bold text-emerald-500 uppercase px-1">üîù TOP INCOME</p>
                        <div id="topInList" class="space-y-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav class="flex justify-around bg-white/80 backdrop-blur-md sticky top-0 z-50 pt-10 border-b">
        <button onclick="showP('w')" id="tW" class="py-4 px-10 font-bold tab-active">Wallet</button>
        <button onclick="showP('p')" id="tP" class="py-4 px-10 font-bold text-stone-400">Portfolio</button>
    </nav>

    <div id="pW" class="p-5 space-y-5">
        <div class="flex justify-between items-center">
            <button onclick="openReport()" class="px-4 py-2 bg-white rounded-full shadow-sm font-bold text-[10px] border border-black/5">üìä ANALYTICS</button>
            <h1 id="uN" contenteditable="true" onblur="sU()" class="text-lg font-bold outline-none">My Wallet</h1>
            <button onclick="toggleModal('setModal', true)" class="w-10 h-10 bg-white rounded-full shadow-sm text-lg flex items-center justify-center">‚öôÔ∏è</button>
        </div>

        <div class="card p-8 text-center shadow-sm relative">
            <p class="text-[11px] opacity-40 font-bold" data-k="totalB">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
            <h2 id="total" class="text-4xl font-black tracking-tight">‡∏ø0</h2>
            <div class="mt-6">
                <div class="flex justify-between text-[10px] mb-2 font-bold uppercase">
                    <span class="opacity-40" data-k="budTrack">Budget Tracker</span>
                    <span id="bP">0%</span>
                </div>
                <div class="progress-bar"><div id="bF" class="progress-fill" style="width: 0%"></div></div>
                <div class="flex justify-between mt-2 text-[9px] font-bold opacity-60">
                    <span id="spendLabel">Used: ‡∏ø0</span>
                    <span id="budgetLabel">Limit: ‡∏ø0</span>
                </div>
            </div>
        </div>

        <div id="sList" class="flex gap-2 overflow-x-auto no-scrollbar py-1"></div>

        <div class="card p-6 space-y-4 shadow-lg border-t-4" id="inputBox">
            <div class="flex gap-2 p-1 bg-black/5 rounded-2xl">
                <button onclick="setT('income')" id="bI" class="flex-1 py-3 rounded-xl text-xs font-bold transition-all" data-k="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
                <button onclick="setT('expense')" id="bE" class="flex-1 py-3 rounded-xl text-xs font-bold transition-all" data-k="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <input type="date" id="rD" class="p-3 bg-black/5 rounded-xl text-[11px] outline-none">
                <input type="number" id="amt" placeholder="0.00" class="p-3 bg-black/5 rounded-xl font-bold outline-none">
            </div>
            <input type="text" id="nt" class="w-full p-4 bg-black/5 rounded-xl text-sm outline-none">
            <button onclick="addD()" id="sv" class="w-full py-4 text-white rounded-2xl font-bold shadow-lg" data-k="save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>

        <div id="hList" class="space-y-3 pb-10"></div>
    </div>

    <div id="pP" class="p-5 hidden space-y-5">
        <div class="card p-8 bg-stone-900 text-white shadow-xl text-center">
            <p class="text-[10px] opacity-50 font-bold uppercase tracking-widest">Total Net Worth</p>
            <h3 id="nW" class="text-4xl font-bold">‡∏ø0</h3>
            <div class="mt-8 pt-6 border-t border-white/10">
                <div class="flex justify-between text-[10px] mb-2 font-bold uppercase"><span class="opacity-50 tracking-widest">Goal Progress</span><span id="gP">0%</span></div>
                <div class="progress-bar bg-white/10"><div id="gF" class="progress-fill bg-emerald-400" style="width: 0%"></div></div>
                <p id="gS" class="text-[9px] mt-3 opacity-40 font-medium"></p>
            </div>
        </div>
        <div class="card p-5 h-64"><canvas id="pC"></canvas></div>
        <div class="space-y-3" id="portInputs"></div>
        <button onclick="snap()" class="w-full py-5 bg-stone-800 text-white rounded-2xl font-bold shadow-xl">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        <div id="phList" class="space-y-3 pb-10"></div>
    </div>

    <script>
        const themes = {
            classic: { bg: '#FDFBF0', text: '#4A4A4A', primary: '#5F7444', accent: '#E9967A' },
            lemon: { bg: '#F7FFE5', text: '#4A5D23', primary: '#A1C298', accent: '#C4D7B2' },
            sakura: { bg: '#FFF0F5', text: '#5D4037', primary: '#F8BBD0', accent: '#F48FB1' },
            sea: { bg: '#E3F4F4', text: '#2C3333', primary: '#B9EDDD', accent: '#87CBB9' },
            ocean: { bg: '#D1D9DE', text: '#1A3C40', primary: '#297376', accent: '#5C9396' },
            midnight: { bg: '#011A1D', text: '#C1D9DE', primary: '#5C9396', accent: '#013137' }
        };

        const lang = {
            th: { settings: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤', langTitle: '‡∏†‡∏≤‡∏©‡∏≤', themeTitle: '‡∏ò‡∏µ‡∏°‡∏™‡∏µ', setBud: '‡∏á‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', setGoal: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö', save: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', analytics: '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô', monthIn: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', monthEx: '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', totalB: '‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', budTrack: '‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', income: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', expense: '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', note: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...', months: ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'] },
            en: { settings: 'Settings', langTitle: 'Language', themeTitle: 'Theme', setBud: 'Monthly Budget', setGoal: 'Savings Goal', save: 'Save', analytics: 'Analytics', monthIn: 'Income', monthEx: 'Expense', totalB: 'Total Balance', budTrack: 'Spending Tracker', income: 'Income', expense: 'Expense', note: 'Note details...', months: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] }
        };

        let recs = JSON.parse(localStorage.getItem('atp_recs')) || [];
        let port = JSON.parse(localStorage.getItem('atp_port')) || {dime:0, webull:0, pvd:0, cash:0};
        let phist = JSON.parse(localStorage.getItem('atp_hist')) || [];
        let shorts = JSON.parse(localStorage.getItem('atp_shorts')) || { income: [], expense: [] };
        let conf = JSON.parse(localStorage.getItem('atp_conf')) || { budget: 20000, goal: 1000000, theme: 'classic', lang: 'th' };
        let selectedMonth = new Date().getMonth();
        let curT = 'expense';
        let myChart, myBarChart;

        function toggleModal(id, show) { document.getElementById(id).classList.toggle('hidden', !show); if(id==='reportModal' && show) renderMonthSelector(); }

        function setTheme(t) {
            conf.theme = t;
            const th = themes[t];
            document.documentElement.style.setProperty('--bg', th.bg);
            document.documentElement.style.setProperty('--primary', th.primary);
            document.documentElement.style.setProperty('--accent', th.accent);
            document.documentElement.style.setProperty('--text', th.text);
            document.body.style.backgroundColor = th.bg;
            document.body.style.color = th.text;
            setT(curT);
        }

        function setLang(l) { conf.lang = l; updateUI(); }

        function updateUI() {
            document.querySelectorAll('[data-k]').forEach(el => { 
                const key = el.getAttribute('data-k');
                if(lang[conf.lang][key]) el.innerText = lang[conf.lang][key]; 
            });
            document.getElementById('nt').placeholder = lang[conf.lang].note;
            document.getElementById('lTH').className = `flex-1 py-2 rounded-xl border font-bold text-xs ${conf.lang === 'th' ? 'bg-stone-800 text-white' : 'bg-white'}`;
            document.getElementById('lEN').className = `flex-1 py-2 rounded-xl border font-bold text-xs ${conf.lang === 'en' ? 'bg-stone-800 text-white' : 'bg-white'}`;
        }

        function saveConf() {
            conf.budget = parseFloat(document.getElementById('confB').value) || 20000;
            conf.goal = parseFloat(document.getElementById('confG').value) || 1000000;
            localStorage.setItem('atp_conf', JSON.stringify(conf));
            toggleModal('setModal', false);
            renderW(); renderP();
        }

        function setT(t) {
            curT = t;
            const th = themes[conf.theme];
            document.getElementById('bI').style.background = t === 'income' ? th.primary : 'transparent';
            document.getElementById('bI').style.color = t === 'income' ? '#fff' : '#9ca3af';
            document.getElementById('bE').style.background = t === 'expense' ? th.accent : 'transparent';
            document.getElementById('bE').style.color = t === 'expense' ? '#fff' : '#9ca3af';
            document.getElementById('inputBox').style.borderTopColor = t === 'income' ? th.primary : th.accent;
            document.getElementById('sv').style.background = t === 'income' ? th.primary : th.accent;
            renderShorts();
        }

        function renderShorts() {
            const area = document.getElementById('sList');
            area.innerHTML = (shorts[curT] || []).map(s => `<button onclick="document.getElementById('nt').value='${s}'" class="shortcut-btn">${s}</button>`).join('');
        }

        function addD() {
            const a = parseFloat(document.getElementById('amt').value);
            const n = document.getElementById('nt').value.trim();
            if(!a || !n) return;
            if(!shorts[curT].includes(n)) {
                shorts[curT].unshift(n);
                if(shorts[curT].length > 6) shorts[curT].pop();
                localStorage.setItem('atp_shorts', JSON.stringify(shorts));
            }
            recs.unshift({ type: curT, amount: a, note: n, date: document.getElementById('rD').value || new Date().toISOString().split('T')[0] });
            localStorage.setItem('atp_recs', JSON.stringify(recs));
            document.getElementById('amt').value = ''; document.getElementById('nt').value = '';
            renderW();
        }

        function renderW() {
            let total = 0, monthlyExp = 0, thisM = new Date().getMonth();
            const list = document.getElementById('hList'); list.innerHTML = '';
            recs.forEach((r, i) => {
                total += (r.type === 'income' ? r.amount : -r.amount);
                const rDate = new Date(r.date);
                if(r.type === 'expense' && rDate.getMonth() === thisM && rDate.getFullYear() === new Date().getFullYear()) monthlyExp += r.amount;
                list.innerHTML += `<div class="card p-5 flex justify-between items-center shadow-sm border-r-4 ${r.type==='income'?'border-emerald-400':'border-rose-400'}"><div class="flex flex-col"><span class="text-xs font-bold">${r.note}</span><span class="text-[9px] opacity-30 mt-1">${r.date}</span></div><div class="flex items-center gap-4"><span class="font-bold text-sm ${r.type==='income'?'text-emerald-500':'text-rose-500'}">${r.type==='income'?'+':'-'}${r.amount.toLocaleString()}</span><button onclick="delR(${i})" class="text-stone-200">‚úï</button></div></div>`;
            });
            document.getElementById('total').innerText = '‡∏ø' + total.toLocaleString();
            const pct = (monthlyExp / conf.budget) * 100;
            const fill = document.getElementById('bF');
            document.getElementById('bP').innerText = pct.toFixed(0) + '%';
            document.getElementById('spendLabel').innerText = `Used: ‡∏ø${monthlyExp.toLocaleString()}`;
            document.getElementById('budgetLabel').innerText = `Limit: ‡∏ø${conf.budget.toLocaleString()}`;
            fill.style.width = Math.min(pct, 100) + '%';
            if(pct <= 60) fill.style.backgroundColor = '#10B981';
            else if(pct <= 75) fill.style.backgroundColor = '#FBBF24';
            else if(pct <= 90) fill.style.backgroundColor = '#F97316';
            else fill.style.backgroundColor = '#EF4444';
            renderShorts();
        }

        function renderMonthSelector() {
            const container = document.getElementById('monthSelector');
            const months = lang[conf.lang].months;
            container.innerHTML = months.map((m, i) => `
                <button onclick="changeMonth(${i})" class="month-btn ${selectedMonth === i ? 'active' : ''}">${m}</button>
            `).join('');
            // Scroll to selected
            const activeBtn = container.children[selectedMonth];
            if(activeBtn) activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }

        function changeMonth(m) {
            selectedMonth = m;
            renderMonthSelector();
            openReport();
        }

        function openReport() {
            let mIn = 0, mEx = 0, exCats = {}, inCats = {};
            const thisYear = new Date().getFullYear();

            recs.forEach(r => {
                const rDate = new Date(r.date);
                if (rDate.getMonth() === selectedMonth && rDate.getFullYear() === thisYear) {
                    if(r.type === 'expense') { mEx += r.amount; exCats[r.note] = (exCats[r.note] || 0) + r.amount; }
                    else { mIn += r.amount; inCats[r.note] = (inCats[r.note] || 0) + r.amount; }
                }
            });

            document.getElementById('monthInTotal').innerText = `‡∏ø${mIn.toLocaleString()}`;
            document.getElementById('monthExTotal').innerText = `‡∏ø${mEx.toLocaleString()}`;
            
            const sortIn = Object.keys(inCats).sort((a,b) => inCats[b] - inCats[a]).slice(0, 5);
            const sortEx = Object.keys(exCats).sort((a,b) => exCats[b] - exCats[a]).slice(0, 5);
            
            document.getElementById('topInList').innerHTML = sortIn.map(k => `<div class="flex justify-between text-xs p-2 bg-emerald-50/50 rounded-lg"><span>${k}</span><b>‡∏ø${inCats[k].toLocaleString()}</b></div>`).join('') || '<p class="text-[9px] opacity-30 px-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            document.getElementById('topExList').innerHTML = sortEx.map(k => `<div class="flex justify-between text-xs p-2 bg-rose-50/50 rounded-lg"><span>${k}</span><b>‡∏ø${exCats[k].toLocaleString()}</b></div>`).join('') || '<p class="text-[9px] opacity-30 px-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            
            renderBarChart(sortEx, exCats);
            toggleModal('reportModal', true);
        }

        function renderBarChart(labels, dataObj) {
            const ctx = document.getElementById('reportBarChart').getContext('2d');
            if (myBarChart) myBarChart.destroy();
            myBarChart = new Chart(ctx, {
                type: 'bar', data: { labels: labels, datasets: [{ data: labels.map(l => dataObj[l]), backgroundColor: themes[conf.theme].accent, borderRadius: 8 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { ticks: { font: { family: 'Prompt', size: 10 } } } } }
            });
        }

        function renderP() {
            const net = Object.values(port).reduce((a, b) => a + b, 0);
            document.getElementById('nW').innerText = '‡∏ø' + net.toLocaleString();
            const gPct = (net / conf.goal) * 100;
            document.getElementById('gP').innerText = gPct.toFixed(1) + '%';
            document.getElementById('gF').style.width = Math.min(gPct, 100) + '%';
            document.getElementById('gS').innerText = `‡∏≠‡∏µ‡∏Å ‡∏ø${Math.max(conf.goal - net, 0).toLocaleString()} ‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢`;
            const names = {dime:'üü¢ Dime', webull:'üîµ Webull', pvd:'üíé P. Fund', cash:'üü° Cash'};
            document.getElementById('portInputs').innerHTML = Object.keys(port).map(k => `
                <div class="card p-4 flex justify-between items-center border-l-[6px] border-stone-200">
                    <span class="text-xs font-bold">${names[k]}</span>
                    <input type="number" onchange="upP('${k}',this.value)" value="${port[k]}" class="text-right font-bold w-1/2 outline-none">
                </div>
            `).join('');
            document.getElementById('phList').innerHTML = phist.map((h, i) => {
                const prev = phist[i+1];
                let diff = '';
                if(prev) {
                    const pct = ((h.total - prev.total) / prev.total) * 100;
                    diff = `<span class="text-[9px] ${pct >= 0 ? 'text-emerald-500' : 'text-rose-500'}">(${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%)</span>`;
                }
                return `<div class="card p-4 flex justify-between items-center text-xs"><span>${h.date}</span><div class="flex items-center gap-3">${diff}<b>‡∏ø${h.total.toLocaleString()}</b><button onclick="delPH(${i})" class="text-stone-200">‚úï</button></div></div>`
            }).join('');
        }

        function renderPC() {
            const ctx = document.getElementById('pC').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Dime', 'Webull', 'P.Fund', 'Cash'], datasets: [{ data: Object.values(port).map(v=>v||0.001), backgroundColor: ['#10B981', '#2563EB', '#38BDF8', '#FBBF24'], borderWidth: 0 }] }, options: { cutout: '75%', maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        }

        function showP(p) {
            document.getElementById('pW').classList.toggle('hidden', p !== 'w');
            document.getElementById('pP').classList.toggle('hidden', p !== 'p');
            document.getElementById('tW').className = `py-4 px-10 font-bold ${p === 'w' ? 'tab-active' : 'text-stone-400'}`;
            document.getElementById('tP').className = `py-4 px-10 font-bold ${p === 'p' ? 'tab-active' : 'text-stone-400'}`;
            if(p === 'p') { renderP(); renderPC(); }
        }

        function delR(i) { if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) { recs.splice(i, 1); localStorage.setItem('atp_recs', JSON.stringify(recs)); renderW(); } }
        function delPH(i) { if(confirm('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏µ‡πâ?')) { phist.splice(i, 1); localStorage.setItem('atp_hist', JSON.stringify(phist)); renderP(); } }
        function upP(k, v) { port[k] = parseFloat(v) || 0; localStorage.setItem('atp_port', JSON.stringify(port)); renderP(); renderPC(); }
        function snap() { phist.unshift({ date: new Date().toLocaleDateString(), total: Object.values(port).reduce((a, b) => a + b, 0) }); localStorage.setItem('atp_hist', JSON.stringify(phist)); renderP(); }
        function sU() { localStorage.setItem('atp_usr', document.getElementById('uN').innerText); }

        document.getElementById('rD').valueAsDate = new Date();
        document.getElementById('confB').value = conf.budget;
        document.getElementById('confG').value = conf.goal;
        document.getElementById('uN').innerText = localStorage.getItem('atp_usr') || 'My Wallet';
        setTheme(conf.theme); updateUI(); renderW();
    </script>
</body>
</html>
